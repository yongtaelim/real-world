# 비즈니스 규칙 엔진
## 목표
- 테스트 주도 개발 기법으로 새로운 설계 문제를 풀어나가는 방법
- 유닛 테스트를 구현하는 데 유요한 모킹(Mocking) 기법
- 지역 변수 형식 추론, switch문 등 몇 가지 최신 자바 기능도 살펴본다.
- 빌더 패턴과 인터페이스 분리 원칙으로 사용자 친화적인 API 개발 방법을 배운다.

## 비즈니스 규칙 엔진 요구 사항
- 팩트 : 규칙이 확인할 수 있는 정보
- 액션 : 수행하려는 동작
- 조건 : 액션을 언제 발생시킬지 지정
- 규칙 : 실행하려는 비즈니스 규칙을 지정, 보통 팩트, 액션, 조건을 한 그룹으로 묶어 규칙으로 만듦  
비즈니스 규칙 엔진의 생산성과 관련된 좋은 점은 규칙이 기존의 응용프로그램과는 독립된 곳에서 실행, 유지보수, 테스트할 수 있다는 점이다.

## 테스트 주도 개발
- 액션 추가
- 액션 실행
- 기본 보고  
테스트 주도 개발 철학은 테스트 코드를 먼저 만든 후, 이에 맞춰 코드를 구현하는 것이다.

### TDD 사용 이유?
- 테스트를 따로 구현하므로 테스트에 대응하는 요구 사항을 한 개씩 구현할 때마다 필요한 요구 사항에 집중하고 개선할 수 있다.
- 코드를 올바르게 조작할 수 있다. 예를 들어 먼저 테스트를 구현하면서 코드에 어떤 공개 인터페이스를 만들어야하는지 신중히 검토하게 된다.
- TDD 주기에 따라 요구 사항 구현을 반복하면서 종합적인 테스트 스위트를 완성할 수 있으므로 요구 사항을 만족시켰다는 사실을 조금 더 확신할 수 있으며 버그 발생 범위도 줄일 수 있다.
- 테스트를 통과하기 위한 코드를 구현하기 때문에 필요하지 않은 테스트를 구현하는 일을 줄일 수 있다.

### TDD 주기
1. 실패하는 테스트 구현
2. 모든 테스트 실행
3. 기능이 동작하도록 코드 구현
4. 모든 테스트 실행

여기에 TDD 주기를 개선한다면 3번 다음 리팩터링을 추가한다.

## 모킹
- 모킹 라이브러리인 모키토를 이용한다.
1. 목 생성
2. 메서드가 호출되었는지 확인

### 지역변수 형식 추론
- 형식 추론 ( type interface ) 이란 컴파일러가 정적 형식을 자동으로 추로내 결정하는 기능
```
// 이렇게 할 필요 없다
Map<String, String> facts = new HashMap<String, String>();

// 형식 추론 방법
Map<String, String> facts = new HashMap<>();
```
이 기능은 다이아몬드 연산자라는 기능이다.
var 변수도 있지만 주관적으로는 비추천한다. 가독성문제로..

### switch 문
- switch문에 폴스루란 break를 걸지않아 다음 case문을 실행하여 예상치 못한 버그 발생을 말한다.
```
switch(dealStage) {
    case LEAD:
        forcecasetedAmount = amount * 0.2;
        break;
    case EVALUATING:
        forcecasetedAmount = amount * 0.5;
        break;
    case INTERESTED:
        forcecasetedAmount = amount * 0.8;
        break;
    case CLOSED:
        forcecasetedAmount = amount;
        break;
    
}
```
폴스루 방지하는 switch문
```
// enum에 switch를 사용하면 자바 컴파일러가 모든 enum 값을 switch에서 소모했는지 확인한다.
forecastedAmount = aount * switch (dealStage) {
    case LEAD -> 0.2;
    case EVALUATING -> 0.5;
    case INTERESTED -> 0.8;
    case CLOSED -> 1;
}
```

## 인터페이스 분리 원칙
- 어떤 클래스도 사용하지 않는 메서드에 의존성을 갖지 않아야한다. 이는 불필요한 결합을 만들기 떄문이다.
- SRP와 비슷하게 보일 수 있지만 관점이 다르다. ISP는 설계가 아닌 사용자 인터페이스에 초점을 둔다.
- 인터페이스가 커지면 인터페이스 사용자는 결국 사용하지 않는 기능을 갖게 되며 이는 불필요한 결합도를 만든다.

## 플루언트 API 설계
### 풀루언트 API란
- 특정 문제를 더 직관적으로 해결할 수 있도록 특정 도메인에 맞춰진 API를 가리킨다.
- 메서드 체이닝을 이용하면 더 복잡한 연산도 지정하 수 있다.
  - 자바 스트림 API에서는 문제를 실제로 해결하는 데 필요한 언어를 사용하는 것처럼 데이터 처리 쿼리를 지정한다.
  - 스프링 통합은 엔터프라이즈 통합 패턴 도메인에 가까운 어휘로 엔터프라이즈 통합 패턴을 지정하는 자바 API를 제공한다.
  - JOOQ는 직관적 API로 다양한 데이터베이스와 상호작용하는 기능을 제공하는 라이브러리다.

### 도메인 모델링
- 어떤 조건이 주어졌을 때(when) '이런작업을 한다(then)' 같은 간단한 조합을 규칙으로 지정할 수있따.
- 도메인은 세가지 개념이 있다.
  - 조건 : 어떤 팩트에 적용할 조건(참이나 거짓으로 평가됨)
  - 액션 : 실행할 연산이나 코드 집합.
  - 규칙 : 조건과 액션을 합친 것. 조건이 참일 때만 액션을 실행한다.

### 빌더 패턴
- 객체에 필요한 조건, 액션을 만드는 과정을 개선할 수 있따.
- 빌더 패턴은 단순하게 객체를 만드는 방법을 제공한다.
- 생성자의 파라미터를 분해해서 각각의 파라미터를 받는 여러 메서드로 분리한다. 덕분에 각 메서드는 도메인이 다루는 문제와 비슷한 이름을 갖는다.

## 총정리
- 테스트 주도 개발 철학에 따르면 먼저 테스트를 구현하고 이를 가이드 삼아 코드를 구현한다.
- 모킹으로 유닛 테스트에서 어떤 동작이 실행되었는지 확인한다.
- 자바는 지역 변수 형식 추론과 switch문을 지원한다.
- 빌더 패턴은 복잡한 객체를 사용자 친화적인 API로 인스턴스화할 수 있도록 돕는다.
- 인터페이스 분리 원칙은 불필요한 메서드의 디펜던시를 감소시켜 높은 응집도를 촉진한다. 큰 인터페이스를 응집력있는 작은 인터페이스로 분리해 사용자는 필요한 기능만 사용할 수 있다.

# junit 기능 리스트
- verify() 특정 메서드가 호출되었는지 확인하는 어서션
  - verify(mock).perform() : mock 객체에 perform() 메서드가 호출되었는지 확인
